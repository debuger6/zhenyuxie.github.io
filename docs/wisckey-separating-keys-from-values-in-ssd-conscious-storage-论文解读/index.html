<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content><meta itemprop=description content="Simple is the best."><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="技术,知识"><meta property="og:type" content="article"><meta property="og:title" content="debuger"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="0001-01-01 00:00:00 +0000 UTC"><meta property="article:modified_time" content="0001-01-01 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB","permalink":"/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/","title":"","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>- debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>16</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#1-介绍>1 介绍</a></li><li><a href=#2-background-and-motivation>2 Background and Motivation</a></li><li><a href=#3-wisckey>3 WiscKey</a><ul><li><a href=#31-design-goals>3.1 Design Goals</a></li><li><a href=#32-key-value-separation>3.2 Key-Value Separation</a></li><li><a href=#33-challenges>3.3 Challenges</a><ul><li><a href=#331-parallel-range-query>3.3.1 Parallel Range Query</a></li><li><a href=#332-garbage-collection>3.3.2 Garbage Collection</a></li><li><a href=#333-crash-consistency>3.3.3 Crash Consistency</a></li></ul></li><li><a href=#34-optimizations>3.4 Optimizations</a><ul><li><a href=#341-value-log-write-buffer>3.4.1 Value-Log Write Buffer</a></li><li><a href=#342-optimizing-the-lsm-tree-log>3.4.2 Optimizing the LSM-tree Log</a></li></ul></li></ul></li><li><a href=#4-benchmark>4 Benchmark</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>16</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>11</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>16</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/debuger6 title="Github → https://github.com/debuger6" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=44429></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=98></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-09-05T23:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/debuger6 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content><meta itemprop=description content="1 介绍 LSM-tree（Log-Structured Merge Tree）是一种常见的数据结构，其具备高效的写入性能和较好的查询能力，很多键值数据库选择这种结构来实现存储引擎，比如 RocksDB、LevelDB、HBase 等。
传统的机械硬盘 （HDDs） 随机 IO 速度比顺序 IO 慢了两个数量级以上，LSM-tree 先将数据缓存在内存中，然后再一把刷入磁盘形成 SST，天然地将随机 IO 转换成顺序 IO，恰好规避了 HDDs 的最大弊端。将 LSM-tree 应用在 HDDs 上能取得很好的效果。
为了平衡查询性能， LSM-tree 会在后台将磁盘上的 SST 排序合并在一起，一份数据在其生命周期内可能会被读取写入多次，会造成 IO 放大。随着现代存储设备的发展，固态硬盘（SSDs）使用越来越广泛，然而，SSDs 和 HDDs 本质上有很大的区别，主要表现为如下几点：
相比于 HDDs，SSDs 的随机 IO 性能和顺序 IO 性能的差异并没有那么大，LSM Tree 用磁盘带宽换取顺序写的收益表现得没那么明显 SDD 内部具备并行访问能力，构建在 SSD 上的 LSM Tree 在设计上应该充分考虑并行性 大量的写入操作对 SSD 会造成磨损，因此 LSM Tree 的写入放大会减少设备的生命周期 基于上述背景，论文提出了一种称为 WiscKey 的键值存储，其实现了一种专门针对 SSD 的 LSM-tree。WiscKey 的核心思想是将 keys 和 values 分离，keys 存储到 LSM-tree，values 单独存储在日志文件中。"></span><header class=post-header><h1 class=post-title itemprop="name headline"></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:0001-01-01 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="0001-01-01 00:00:00 +0000 UTC">0001-01-01</time></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>572</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>3min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=1-介绍>1 介绍</h2><p>LSM-tree（Log-Structured Merge Tree）是一种常见的数据结构，其具备高效的写入性能和较好的查询能力，很多键值数据库选择这种结构来实现存储引擎，比如 RocksDB、LevelDB、HBase 等。</p><p>传统的机械硬盘 （HDDs） 随机 IO 速度比顺序 IO 慢了两个数量级以上，LSM-tree 先将数据缓存在内存中，然后再一把刷入磁盘形成 SST，天然地将随机 IO 转换成顺序 IO，恰好规避了 HDDs 的最大弊端。将 LSM-tree 应用在 HDDs 上能取得很好的效果。</p><p>为了平衡查询性能， LSM-tree 会在后台将磁盘上的 SST 排序合并在一起，一份数据在其生命周期内可能会被读取写入多次，会造成 IO 放大。随着现代存储设备的发展，固态硬盘（SSDs）使用越来越广泛，然而，SSDs 和 HDDs 本质上有很大的区别，主要表现为如下几点：</p><ul><li>相比于 HDDs，SSDs 的随机 IO 性能和顺序 IO 性能的差异并没有那么大，LSM Tree 用磁盘带宽换取顺序写的收益表现得没那么明显</li><li>SDD 内部具备并行访问能力，构建在 SSD 上的 LSM Tree 在设计上应该充分考虑并行性</li><li>大量的写入操作对 SSD 会造成磨损，因此 LSM Tree 的写入放大会减少设备的生命周期</li></ul><p>基于上述背景，论文提出了一种称为 <strong>WiscKey</strong> 的键值存储，其实现了一种专门针对 SSD 的 LSM-tree。WiscKey 的核心思想是将 keys 和 values 分离，keys 存储到 LSM-tree，values 单独存储在日志文件中。</p><p>这种简单的技术有效地降低了写放大，由于 values 没有存储在 LSM-tree 中，那么 LSM-tree 的大小自然就减小了，也就意味着可以将更多 LSM-tree 的数据缓存在内存中，进一步提升查询性能。</p><p>另外，kv 分离也会带来一些弊端：</p><ul><li>kv 分离后，scan 的性能势必会受到影响，因为 values 并不是按照 keys 有序排列的，因此会带来很多的随机 IO</li><li>WiscKey 需要通过 gc 来清理一些无用的 values，gc 会消耗系统资源，影响前台性能</li><li>Kv 分离会来一致性问题</li></ul><p>后面章节会介绍 WiscKey 是如何解决上述问题的。</p><h2 id=2-background-and-motivation>2 Background and Motivation</h2><p>LSM-tree 和 LevelDB 就不过多介绍了，整体架构如下：</p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/lsm-leveldb-arch.png alt=image-20230610205730216 style=zoom:50%><p>LSM-tree 主要问题就是读写放大，比如 LevelDB，我们来分析下 LevelDB 的读写放大问题。由于 LevelDB 的分层设计，$L_i$ 层的大小是 $L_{i-1}$ 的 10 倍，compaction 时，在最坏情况下，需要将 $L_{i-1}$ 层的 1 个文件和 $L_i$ 层的 10 文件做合并排序，然后再写入到 $L_i$ 层，所以相邻两层间的 compaction 写放大最高可以达到 10 倍。</p><p>对于大量数据集的写入，会不断新生新的文件，大部分文件经过 compaction，从 $L_0$ 迁移到 $L_6$ 写入放大超过 50 倍（$L_1$ 到 $L_6$ 每层写入放大 10 倍）。</p><p>对于读操作，最坏情况下，需要查找所有层的文件，$L_0$ 层查找 8 个文件（$L_0$ 层文件数据有重叠），其他 6 层各查找一个文件。而每个文件需要读取 16KB index block，4KB bloom filter block，4KB data block，一共 24KB，14 个文件一共 336KB。假设一个 key-value 键值对 1KB，那么读放大为 336。</p><p>总体来说，数据量越大，数据就容易往底层迁移，也就会造成更高的读写放大。如下：</p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/write-read-amplification.png alt=image-20230619224551219 style=zoom:50%><h2 id=3-wisckey>3 WiscKey</h2><p>WiscKey 的四个重要思想：</p><ol><li>Key 和 Value 分开存储，keys 依然存放在 LSM-tree，values 存放在 log 文件</li><li>由于 values 未按照 keys 的顺序存储，在范围查询时，会导致随机读，WiscKey 使用 SSD 的特性并行读取数据</li><li>WiscKey 使用崩溃一致性（crash-consistency）和垃圾回收器（garbage- collection）来有效管理 log</li><li>WiscKey 在保证一致性的前提下，去除 WAL 来优化性能</li></ol><h3 id=31-design-goals>3.1 Design Goals</h3><p>WiscKey 想达成的主要目标如下：</p><p><code>低写放大</code>，写放大消耗大量的写带宽，降低 SSD 的使用寿命，降低写放大即可改善系统负载，还能提升 SSD 的使用寿命。因此，降低写放大至关重要。</p><p><code>低读放大</code>，读放大会导致两个问题，第一，每次查询会到来多次读取操作，降低查询吞吐；第二，读放大会造成大量数据加载到内存，降低缓存效率，WiscKey 的目标是降低读放大，加快查询速度。</p><p><code>针对 SSD 优化</code>，WiscKey 专门针对 SSD 的特性来做优化。特别是通过高效的顺序写和并发随机读来充分利用设备的带宽。</p><p><code>特性丰富的 API</code></p><p><code>Realistic key-value sizes</code>，这里论文要表达的意思应该是 key 的长度有大有小，但是在实际情况下，key 的大小常常是比较小的。WiscKey 旨在针对大部分情况下的 key 大小提供高效的性能。</p><h3 id=32-key-value-separation>3.2 Key-Value Separation</h3><p>LSM-tree 最主要的性能开销是 compaction，在 compaction 过程中，多个文件会被读到内存排序然后写回磁盘，这一系列的操作会影响到前台的性能。</p><p>WiscKey 将 keys 和 values 分离，compaction 只将 keys 读取到内存排序。因为 key 往往远小于 value，所以参与排序的数据量大大减少。在大 value 场景下，key-value 分离能够显著地降低写入放大。</p><p>假设 key 的大小为 16B，value 的大小为 1KB，key 在 LSM-tree 中的写放大为 10，value 的写放大为 1。那么 key-value 整体的写放大为 $(10 \times16+1024)/(16+1024)=1.14$。可以看到，通过 key-value 分离，写放大被有效的稀释掉了。</p><p>WiscKey 的架构如下：</p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-layout.png alt=image-20230617110541612 style=zoom:50%><p>key 和 value 的地址存在 LSM-tree 中，value 存在日志文件 vlog 中。当插入一个 key-value 键值对时，先将 value 追加到 vlog，然后再将 key 和 value 的地址插入 LSM-tree。</p><p>删除也很简单，只需要将 key 从 LSM-tree 中删除（标删）即可。vlog 中所有有效值在 LSM-tree 中都有对应的 key，无效值将会被垃圾回收器清理掉。</p><p>WiscKey 在查询时，首先从 LSM-tree 中定位 key，进而得到 value 在 vlog 中的地址；然后，根据地址到 vlog 中获取 value。从流程上来分析，WiscKey 的查询性能应该弱于 LevelDB，因为多了一次查找 value 的 IO。</p><p>但是宏观来看，对于相同数据量， 一方面，WiscKey 的 LSM-tree 比 LevelDB 的更小，也就意味着查找 key 时，需要查找的层数更少；另一方面，LSM-tree 更少，能够缓存的 key 也就更多，因此，命中缓存的概率也就越大。所以，WiscKey 的查询性能往往比 LevelDB 更好。</p><p>WiscKey 的思想看起来很简单，但是其中存在很多挑战。</p><h3 id=33-challenges>3.3 Challenges</h3><h4 id=331-parallel-range-query>3.3.1 Parallel Range Query</h4><p>在 LevelDB 中，由于 key-value 有序存放在一起，范围查询时，可以顺序读取 SST。然而，在 WiscKey 中，key-value 分离存储，范围查询时，需要随机读取 vlog 中的 value，这是很低效的。</p><p>WiscKey 利用 SSD 并行 IO 特性，多线程随机读也能达到顺序读的效果，如下：</p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/seq-random-read-on-ssd.png alt=image-20230619224842283 style=zoom:50%><p>在范围查询时，在 LSM-tree 中预取多个 key-address，然后将 addresses 插入到队列中。多个线程消费队列，得到地址并在 vlog 中并行读取地址对应的 value，从而提升范围查询性能。</p><h4 id=332-garbage-collection>3.3.2 Garbage Collection</h4><p>在标准的 LSM-tree 中，compaction 可以清理掉被删除或者更新前的 key-value。但是在 WiscKey 中 compaction 只能清理掉 keys，values 存放在 vlog 中无法被清理，因此，需要一个特定的垃圾回收器清理 vlog。</p><p>一种直观的想法是，scan LSM-tree 获取所有有效的 value 地址，vlog 中的 value 在 LSM-tree 中没有对应有效地址的被视为无效，然后被清理。然而，这种方法太重，只适合作为线下垃圾回收器。</p><p>WiscKey 旨在构建一个轻量的在线垃圾回收器，为了实现这一目的，WiscKey 对 layout 做了微小的改变：在 vlog 中将 key 和 value 一起存储，如下：</p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-new-data-layout.png alt=image-20230617120640206 style=zoom:50%><p>数据从 head 开始往后追加，垃圾回收器从 tail 开始清理，vlog 中有效数据包含在 head 和 tail 之间，查询是只会查找这个范围内的数据。</p><p>垃圾回收时，从 tail 开始读取一个 chunk 的 key-value，然后根据 key 在 LSM-tree 查找检查是否有效，如果有效则将对应的 key-value 追加到 head 后面。当 chunk 中的数据都检查完毕后，清理释放掉整个 chunk，同时更新 tail 指针。</p><p>为了防止在 gc 过程中系统崩溃丢失数据，WiscKey 将会执行如下步骤，新的有效值追加到 vlog 后，将调用 fsync() 保证数据落盘。然后将 value 对应的地址和 tail 以同步插入的方式添加到 LSM-tree。最后，释放掉 gc 后的空间。</p><h4 id=333-crash-consistency>3.3.3 Crash Consistency</h4><p>原生的 LSM-tree key-value 在一起，容易保证数据插入和恢复的一致性，WiscKey 中 key-value 的插入分成了两步，一致性保证更复杂。那么如何保证崩溃一致性呢？总结来说，分成下面几种情况：</p><ol><li>value 部分写入后崩溃</li><li>value 写入成功，key-offset 还没有写入到 LSM-tree 中，系统崩溃</li><li>Key-offset 写入 LSM-tree 的过程中崩溃，地址写入不全</li></ol><p>第一种情况，value 不全，能够很容易检查出不合法，随后会被 gc 掉；第二种情况，value 虽然写入成功，但是在 gc 的过程中在 LSM-tree 中找不到对应的 key，也会被 gc 掉；第三种情况，地址写入不全，在 gc 时，会检查地址是否在 head 和 tail 范围区间，如果合法会继续比对地址对应的 key 是否匹配，如果不匹配则认为 key 无效，然后从 LSM-tree 中删除掉。</p><h3 id=34-optimizations>3.4 Optimizations</h3><h4 id=341-value-log-write-buffer>3.4.1 Value-Log Write Buffer</h4><p>每次写 vlog 都会调用一次 write() 系统调用，大量的小 io 不利于系统吞吐，解决的方式就是增加一个 vlog 的写缓存，当缓存达到一定阈值时在一把刷入磁盘。查询时，先读缓存，然后再读磁盘。当然，这种方式在系统崩溃时，有丢数据的风险。</p><h4 id=342-optimizing-the-lsm-tree-log>3.4.2 Optimizing the LSM-tree Log</h4><p>在 LevelDB 中会使用 WAL 保证系统在崩溃后能够恢复最近写入的数据。WiscKey 中 vlog 天然有 WAL 的功能，因此 WAL 文件可以省略掉。当 LSM-tree 中的 keys 落盘前系统崩溃，可以从 vlog 中读取数据恢复 keys。</p><p>最基础的方式是 scan 整个 vlog 重建 LSM-tree，这种方法太重，不可取。因为我们只需要从最近落盘时点开始恢复，WiscKey 会周期性的将 head 记录到 LSM-tree 中，系统启动后，只需要读取 LSM-tree 获取 head，然后恢复 head 到 vlog 末尾间的数据即可。</p><h2 id=4-benchmark>4 Benchmark</h2><p><strong>Load Performance</strong></p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-load-perf.png alt=image-20230619230651657 style=zoom:50%><p><strong>Query Performance</strong></p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-query-perf.png alt=image-20230619230825950 style=zoom:50%><p><strong>Garbage Collection</strong></p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-gc.png alt=image-20230619230930342 style=zoom:50%><p><strong>Space Amplification</strong></p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/wisckey-space-amplification.png alt=image-20230619231540427 style=zoom:50%><p><strong>YCSB Benchmarks</strong></p><img src=/Users/xzy/github.com/zhenyuxie/hugo-blog/content/images/lsm/ycsb-benchmarks.png alt=image-20230619231841813 style=zoom:50%><h2 id=conclusions>Conclusions</h2><p>WiscKey 的思想比较简单，但是其中有很多细节需要考虑，要实现一款高效的 WiscKey 存储引擎，还是存在很多挑战。目前有几款开源 key-value 存储引擎实现了 WiscKey，后面再深入研究。</p></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong></li><li class=post-copyright-author><strong>Post Author:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/ title>/wisckey-separating-keys-from-values-in-ssd-conscious-storage-%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/the-adaptive-radix-tree-artful-indexing-for-main-memory-databases/ rel=next title><i class="fa fa-chevron-left"></i></a></div><div class="post-nav-prev post-nav-item"><a href=/flinks.html rel=prev title=站点示例>站点示例
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"debuger6/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.95d37ca8344f2f635c0f13f77cc75191efb6cdf99093ed73203a86e05f995fbb.js defer></script></body></html>