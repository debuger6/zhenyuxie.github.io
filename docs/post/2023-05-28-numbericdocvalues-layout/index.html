<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="lucene DocValues之NumericDocValues"><meta itemprop=description content="Simple is the best."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="lucene,docvalue"><meta property="og:type" content="article"><meta property="og:title" content="lucene DocValues之NumericDocValues"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/2023-05-28-numbericdocvalues-layout/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="2023-05-28 14:30:00 +0000 UTC"><meta property="article:modified_time" content="2023-05-28 14:30:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"2023-05-28-numbericdocvalues-layout","permalink":"/post/2023-05-28-numbericdocvalues-layout/","title":"lucene DocValues之NumericDocValues","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>lucene DocValues之NumericDocValues - debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>18</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#文件-layout>文件 layout</a></li><li><a href=#dvm>dvm</a><ul><li><ul><li><a href=#header>Header</a></li><li><a href=#fieldmeta>FieldMeta</a></li><li><a href=#footer>Footer</a></li></ul></li></ul></li><li><a href=#dvd>dvd</a><ul><li><ul><li><a href=#fielddocvaluesdata>FieldDocValuesData</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>18</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>19</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=50640></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=112></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-09-05T23:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/debuger6 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/2023-05-28-numbericdocvalues-layout/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="lucene DocValues之NumericDocValues"><meta itemprop=description content="其实多年前就已经研究过这块内容，但是久了不看有所遗忘，正好近期工作内容和 lucene 的 DocValues （即列存）打交道比较频繁，顺便记录分享相关内容。本章先介绍最简"></span><header class=post-header><h1 class=post-title itemprop="name headline">lucene DocValues之NumericDocValues</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:2023-05-28 14:30:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-05-28 14:30:00 +0000 UTC">2023-05-28</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E itemprop=url rel=index><span itemprop=name>搜索引擎</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>2186</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>5min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/2023-05-28-numbericdocvalues-layout/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/post/2023-05-28-numbericdocvalues-layout/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>其实多年前就已经研究过这块内容，但是久了不看有所遗忘，正好近期工作内容和 lucene 的 DocValues （即列存）打交道比较频繁，顺便记录分享相关内容。本章先介绍最简单的一种 DocValues – NumericDocValues，后续会分享其他类型 DocValues 的相关内容。本系列文章都是基于 lucene 版本 9.5.0 来讲解。</p></blockquote><h2 id=文件-layout>文件 layout</h2><p>先上图，一图胜千言。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/database/NumericDocValuesLayout.png alt=ES查询进入到lucene层的查询流程></p><p>写文件入口：
<a href=https://github.com/debuger6/lucene/blob/branch-v9.5.0/lucene/core/src/java/org/apache/lucene/codecs/lucene90/Lucene90DocValuesConsumer.java#L130 title=点击进入 rel="noopener external nofollow noreferrer" target=_blank class=exturl>点击进入
<i class="fa fa-external-link-alt"></i></a></p><p>上图代表了整个 NumericDocValues 的文件 layout，主要包括两个文件：.dvm 和 .dvd，下面分别进行介绍。</p><h2 id=dvm>dvm</h2><p>dvm 是 dvd 的元数据，主要由三部分构成：Header、FieldMeta、Footer。</p><h4 id=header>Header</h4><p>固定内容，包含文件的编码信息、版本等，见上图。</p><h4 id=fieldmeta>FieldMeta</h4><p>核心部分，存储每个 Field 相关的 meta 数据。每个 Field 对应一个 FieldMeta，FieldMeta 构成部分如下：</p><h5 id=fieldnumber>FieldNumber</h5><p>Field 编号。</p><h5 id=dvtype>DVType</h5><p>字段 DocValues 类型，这里存的是一个枚举值，NumericDocValues 对应的类型值为 0。</p><h5 id=docswithfieldmeta>DocsWithFieldMeta</h5><p>这个部分是数据文件 dvd 中 docsWithField 的元数据，<strong>docsWithField</strong> 在下文介绍。<strong>DocsWithFieldMeta</strong> 由下面部分构成：</p><ul><li><p><strong>offset & length</strong></p><p>docsWithField 在 dvd 中的偏移和长度。<em><u><strong>如果所有文档都包含该 Field，那么 offset 值为 -2，length 值为 0；如果所有文档都不包含该Field，那么 offset 值为 -1，length 值为 0.</strong></u></em></p></li><li><p><strong>jumpTableEntryCount & denseRankPower</strong></p><p>这两个变量和关键数据结构 <code>IndexedDISI</code> 相关，介绍 <code>IndexedDISI</code> 后再补充。<em><strong><u>如果所有文档都包含或者都不包含该 Field，那么这两个变量的值都为 -1.</u></strong></em></p></li></ul><h5 id=numvalues>NumValues</h5><p>该 Field 在 segment 中的数量，由于 NumericDocValues 类型的字段是单值的，因此 NumValues 和包含该字段的文档个数相同。</p><h5 id=encodetype>EncodeType</h5><p>Field values 在 dvd 中存储的编码类型，分情况讨论：</p><ul><li><p>情况1：所有 values 都相同</p><p>这种情况下，EncodeType 值为 -1。由于所有值都相同，不必将 values 存入到 dvd 中，dvm 中会存一个 min（见下文），代表所有相同的 value。</p></li><li><p>情况2：字典编码</p><p>当 Field values 的基数满足一定条件时，采用字典编码，在 dvd 中存储 values 的编码值。是否采用字典编码的判断条件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>uniqueValues <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> uniqueValues<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>&amp;&amp;</span> DirectWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>unsignedBitsRequired</span><span style=color:#f92672>(</span>uniqueValues<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>&lt;</span> DirectWriter<span style=color:#f92672>.</span><span style=color:#a6e22e>unsignedBitsRequired</span><span style=color:#f92672>((</span>max <span style=color:#f92672>-</span> min<span style=color:#f92672>)</span> <span style=color:#f92672>/</span> gcd<span style=color:#f92672>))</span>
</span></span></code></pre></div><p>也就是说当字典编码的最大值所需的位数比<code>差值&最大公约数</code>所需位数更少时，则使用字典编码。<code>差值&最大公约数编码</code>可以看
<a href=https://debuger.tech/2022/12/13/lucene-dmw/ title=这篇文章 rel="noopener external nofollow noreferrer" target=_blank class=exturl>这篇文章
<i class="fa fa-external-link-alt"></i>
</a>。</p><p>这种情况下 EncodeType 为一个复合结构，如下所示：</p><img src=/images/database/encode_type.png alt=image-20230519223708926 style=zoom:50%><p><strong>length</strong> 表示字段 <strong>uniqueValue</strong> 的个数，后面跟上<strong>排序后</strong>的 <strong>uniqueValues</strong>。比如字段值为 [2, 3, 9, 6, -1, 6, 2]，那么这里存储的内容为：<u>5</u> |-1|2|3|6|9.</p></li><li><p>情况3：差值&最大公约数编码</p><p>这种情况下，字段的每个 value 将按位数为 <em>DirectWriter.unsignedBitsRequired((max - min) / gcd))</em> 存储。同时为了提高压缩效率又将 Field values 的存储方式分为 SingleBlock 和 MultiBlock。如果是 SingleBlock，EncodeType 的值为 -1（和情况1相同，后面会通过 numBitsPerValue 区分）；如果是 MultiBlock，EncodeType 的值为 -16。</p></li></ul><h5 id=encodingmeta>EncodingMeta</h5><p>差值&最大公约数编码所需的元数据，编码公式为 $(v-min)/gcd$，因此元数据包含 <strong>min</strong>、<strong>gcd</strong>，当然还需要编码需要的位数 <strong>numBitsPerValue</strong>，当 EncodeType 为情况1时，numBitsPerValue 为 0。注意，这里 min 还有一个作用是在 EncodeType 为情况1时，代表所有 values 的值。</p><h5 id=fieldvaluesindex>FieldValuesIndex</h5><p>表示 FieldValues 在 dvd 中的偏移 offset 和长度 length。</p><h5 id=jumptableoffset>JumpTableOffset</h5><p>FieldValues 按 Block 存储，JumpTable 可以加速 Block 的定位，JumpTableOffset 表示 JumpTable 在 dvd 中的偏移。</p><h4 id=footer>Footer</h4><p>存校验码，用于校验文件内容，见上图。</p><h2 id=dvd>dvd</h2><p>dvd 由三大部分组成：Header、FieldDocValuesData、Footer。本节主要讲解 FieldDocValuesData 部分，Header、Footer 忽略。</p><h4 id=fielddocvaluesdata>FieldDocValuesData</h4><p>Field 对应的 docValues 数据，包含两部分：docsWithField 和 FieldValues。</p><h5 id=docswithfield>docsWithField</h5><p>包含该 Field 的所有 docs，作用是查询时确定查询的 doc 是否存在以及定位 doc 在 segment 中的偏移。<em><strong><u>当 segment 中所有 docs 都包含或者都不包含该 Field 时，docsWithField 部分不需要存储</u></strong></em>。</p><p>如果 docsWithField 存在，则存储它的数据结构为 IndexedDISI，这个数据结构还是比较有意思，上图画的只是其中一种情况，下一篇文章会详细介绍。</p><h5 id=fieldvalues>FieldValues</h5><p>该 Field 对应的所有 values。FieldValues 的存储结构得分情况讨论，对应 dvm 的 EncodeType。</p><ul><li><p>情况1：所有 values 都相同</p><p>这种情况下，values 不用存储，即 FieldValues 不存在。</p></li><li><p>情况2：字典编码</p><p>这种情况下，dvd 中不用存储 value 的原始值，而是存储 value 的字典映射值，比如原始值为 [6, 9, 5, 8, 5, 6, 7]，那么字典映射表如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>5 --&gt; 0
</span></span><span style=display:flex><span>6 --&gt; 1
</span></span><span style=display:flex><span>7 --&gt; 2
</span></span><span style=display:flex><span>8 --&gt; 3
</span></span><span style=display:flex><span>9 --&gt; 4
</span></span></code></pre></div><p>那么存到 dvd 中的 values 便为 [1, 4, 0, 3, 0, 1, 2]，然后用 DirectWriter 编码存储。DirectWriter 原理请看
<a href=https://debuger.tech/2022/12/04/lucene-dw/ title=这篇文章 rel="noopener external nofollow noreferrer" target=_blank class=exturl>这篇文章
<i class="fa fa-external-link-alt"></i>
</a>。</p></li><li><p>情况3：差值&最大公约数编码</p><p>在讲 dvm 时，已经大体提过，这种情况会分为两种存储方式：SingleBlock 和 MultiBlock，采用这种编码，每个 value 所需的位数为 <em>DirectWriter.unsignedBitsRequired((max - min) / gcd))</em>，因此，当 max - min 越小，所需位数更少。当采用 MultiBlock 的空间开销能节约 10% 以上时，则使用 MultiBlock ，否则使用 SingleBlock。判断条件如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// we do blocks if that appears to save 10+% storage
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>doBlocks <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  minMax<span style=color:#f92672>.</span><span style=color:#a6e22e>spaceInBits</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>double</span><span style=color:#f92672>)</span> blockMinMax<span style=color:#f92672>.</span><span style=color:#a6e22e>spaceInBits</span> <span style=color:#f92672>/</span> minMax<span style=color:#f92672>.</span><span style=color:#a6e22e>spaceInBits</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0.9</span><span style=color:#f92672>;</span>
</span></span></code></pre></div><p>SingleBlock 比较简单，代码见
<a href=https://github.com/debuger6/lucene/blob/branch-v9.5.0/lucene/core/src/java/org/apache/lucene/codecs/lucene90/Lucene90DocValuesConsumer.java#L336 title=点击进入 rel="noopener external nofollow noreferrer" target=_blank class=exturl>点击进入
<i class="fa fa-external-link-alt"></i>
</a>。另外情况 2 也是使用的 SingleBlock 存储的。</p><p>MultiBlock 存储如下：</p><img src=/images/database/fieldvalues_multiblock.png alt=image-20230520230121926 style=zoom:50%><p>每 16384 个 value 切成一个 Block，由于每个 Block 中 <strong>bitPerValue</strong> 和 <strong>min</strong> 不一定相同，因此每个 Block 都会存自己的 bitsPerValue 和 min，<strong>packedData</strong> 即压缩后的数据，<strong>size</strong> 表示 packedData 的大小。在查询时，为了加快 Block 的定位，会使用 JumpTable 存储每个 Block 的偏移。</p></li></ul><h2 id=总结>总结</h2><p>本章讲解了 NumericDocValues 的文件 layout，至于 layout 的生成过程可以看本文提供的源码链接，关键地方笔者都加有注释。下一章将会讲解 NumericDocValues 的读取流程，同时会着重介绍数据结构 IndexedDISI。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/lucene>lucene</a>
<a href=/tags/docvalue>docvalue</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong>
lucene DocValues之NumericDocValues</li><li class=post-copyright-author><strong>Written By:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/post/2023-05-28-numbericdocvalues-layout/ title="lucene DocValues之NumericDocValues">/post/2023-05-28-numbericdocvalues-layout/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/ rel=next title=DuckDB：高性能并行分组聚合><i class="fa fa-chevron-left"></i> DuckDB：高性能并行分组聚合</a></div><div class="post-nav-prev post-nav-item"><a href=/post/2023-04-16-fastest-table-sort/ rel=prev title="Fastest table sort in the West - Redesigning DuckDB’s sort">Fastest table sort in the West - Redesigning DuckDB’s sort
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"debuger6/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.95d37ca8344f2f635c0f13f77cc75191efb6cdf99093ed73203a86e05f995fbb.js defer></script></body></html>