<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="DuckDB：高性能并行分组聚合"><meta itemprop=description content="Simple is the best."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="duckdb,olap"><meta property="og:type" content="article"><meta property="og:title" content="DuckDB：高性能并行分组聚合"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="2023-06-09 23:30:00 +0000 UTC"><meta property="article:modified_time" content="2023-06-09 23:30:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"2023-06-10-parallel-grouped-aggregation-in-duckdb","permalink":"/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/","title":"DuckDB：高性能并行分组聚合","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>DuckDB：高性能并行分组聚合 - debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>14</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#hash-aggregation>Hash Aggregation</a></li><li><a href=#collision-handling>Collision Handling</a></li><li><a href=#parallel-aggregation>Parallel Aggregation</a></li><li><a href=#experiment>Experiment</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>8</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/debuger6 title="Github → https://github.com/debuger6" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=39959></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=88></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-06-09T23:30:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/debuger6 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="DuckDB：高性能并行分组聚合"><meta itemprop=description content="分组聚合对于 OLAP 数据库来说是一个核心的分析算子，常常用于对大规模数据集做分组统计。针对这样一个重要算子，DuckDB 也是做了深度地优化。本文将"></span><header class=post-header><h1 class=post-title itemprop="name headline">DuckDB：高性能并行分组聚合</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:2023-06-09 23:30:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-06-09 23:30:00 +0000 UTC">2023-06-09</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93 itemprop=url rel=index><span itemprop=name>数据库</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>2562</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>6min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>分组聚合对于 OLAP 数据库来说是一个核心的分析算子，常常用于对大规模数据集做分组统计。针对这样一个重要算子，DuckDB 也是做了深度地优化。本文将结合 DuckDB 相关技术资料来分析其背后的优化原理。</p></blockquote><h2 id=introduction>Introduction</h2><p><code>Group By</code>的作用是对按照分组字段，对数据行进行分组聚合，返回所有分组字段的值及其聚合值。举个栗子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    l_returnflag,
</span></span><span style=display:flex><span>    l_linestatus,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>sum</span>(l_extendedprice),
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>avg</span>(l_quantity)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    lineitem
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>    l_returnflag,
</span></span><span style=display:flex><span>    l_linestatus;
</span></span></code></pre></div><p>这个栗子中对表中字段 <code>l_returnflag</code> 和 <code>l_linestatus</code> 做分组。这两个分组字段的所有组合值构成不同的分组。<code>Group By</code> 将数据行放到对应的分组中，从而形成不同的分组数据。投影往往会带上分组字段和其他聚合算子，达到分组聚合的统计目的。上述 SQL 语句的聚合结果如下：</p><img src=/images/database/group_sample.png alt=image-20230609225959547 style=zoom:50%><p>那对于 <code>Group By</code> 算子，DuckDB 的查询引擎是如何工作的呢？我们可以先来设想下，假设要聚合的数据表是按照分组字段排好序的，那对于这种情况就好办了。只需要顺序 SCAN 每一行，读取每行分组字段的组合值，然后上前一行的值做比较，如果一样，那么就将它们划到同一组。否则，将当前行划到新组，不断重复上述步骤直到所有行 SCAN 完毕。可以看出在数据天然按照分组字段有序的情况下，只需一次 SCAN 便能得到分组结果，时间复杂度为 $O(n)$。</p><p>上述分组方式称为 <code>Sorted Aggregation</code>，那对于数据不是按照分组字段有序的情况怎么办呢？一种自然的想法就是首先对输入的表数据按照分组字段排序，然后再使用 <code>Sorted Aggregation</code> 做分组。整体来讲，一般排序的时间复杂度为 $O(nlogn)$，$n$ 为数据表的行数，这个开销相对而言还是比较大的。那么接下来看下还有没有更好的方式来分组。</p><h2 id=hash-aggregation>Hash Aggregation</h2><p><code>Hash Aggregation</code> 其实也是一种常见的分组聚合算法。其核心思想就是利用 <code>Hash Table</code> 存储不同分组的聚合数据，类似于 java 中的 HashMap，key 为分组字段的组合值，value 为聚合值。我们知道，<code>Hash Table</code> 的查找时间复杂度为 $O(1)$，那么将 $n$ 行数据加入到 <code>Hash Table</code> 中，时间复杂度为 $O(n)$，这比 $O(nlogn)$ 好太多了，尤其当数据量达到数十亿条时，这种差距更明显。如下图：</p><img src=/images/database/hash_complicate.png alt=image-20230609232539448 style=zoom:50%><p>除了时间复杂度的优势外，对于排序来说，如果是内排，那么需要将涉及的所有数据都 Copy 到内存，内存开销较大。但是对于 <code>Hash Table</code> 来说，只需要存储所有分组信息即可，这个数据往往远低于原始表数据。</p><h2 id=collision-handling>Collision Handling</h2><p>上面把 <code>Hash Aggregation</code> 说得那么好，是不是它就真的那么完美呢？当然不是，众所周知，<code>Hash Table</code> 在构建的时候常常会遇到 <code>Hash Collision</code> 即哈希碰撞问题。当不同的分组数据哈希到同一个桶时，这时候便出现哈希碰撞问题，那么如何解决呢？</p><p>解决哈希碰撞问题主要有两种方式：<code>拉链法</code> 和 <code>线性探测法</code>。如果使用拉链法，那么每个哈希项其实是一个链表，哈希到同一桶的分组信息插入到同一个链表中，如下：</p><img src=/images/database/chain.png alt=image-20230609235441349 style=zoom:50%><p>如果使用线性探测法，那么也是分组值做哈希，然后映射到对应的桶，如果当前桶有值且和当前分组值相等，那么我们更新聚合值；如果当前桶没有值，那么我们将分组信息直接填充到桶中；如果当前桶有值且和当前分组值不同，那么我们顺序往下找，直到找到分组值相同或者空桶为止。如下所示：</p><table><thead><tr><th style=text-align:center>bucket</th><th style=text-align:center>Group Value</th><th style=text-align:center>Aggregates</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>g0</td><td style=text-align:center>value0</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>g1</td><td style=text-align:center>value1</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center>g2</td><td style=text-align:center>value2</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>g3</td><td style=text-align:center>value3</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>g7</td><td style=text-align:center>value7</td></tr><tr><td style=text-align:center>5</td><td style=text-align:center>g5</td><td style=text-align:center>value5</td></tr><tr><td style=text-align:center>6</td><td style=text-align:center>g6</td><td style=text-align:center>value6</td></tr><tr><td style=text-align:center>7</td><td style=text-align:center>g4</td><td style=text-align:center>value4</td></tr></tbody></table><p>理论上上述两种方式都能较好的处理哈希碰撞问题，但是从计算机硬件的角度来看，由于链表元素在内存中不连续，会带来很多随机访问，对现代硬件架构不友好。而线性探测法不用使用链表，底层的 <code>Hash Table</code> 一般采用数组结构，在内存中是连续的，且线性探测的过程也是顺序访问，根据局部性原理，大部分时候数据能在 CPU Cache 中命中，性能会得到极大提升。因此，DuckDB 选择<code>线性探测</code>处理哈希碰撞。</p><p>如果哈希碰撞的频率太高，那么 <code>Hash Table</code> 的查找时间复杂度降退化为 $O(n)$，这当然是不能接受的，问题的解决办法是，扩容 <code>Hash Table</code>，当 <code>Hash Table</code> 的<code>装载因子</code>超过一定阈值后触发扩容。举个栗子：</p><img src=/images/database/basic_hashtable.png alt=image-20230610101136265 style=zoom:50%><p>上述 <code>Hash Table</code> 有 4 个桶，已经有 3 个桶被占用，装载因子为 75%，将触发扩容。<code>Hash Table</code> 一旦扩容，那之前数据则需要 <code>rehash</code> 重新挪动位置。数据搬迁是个非常重的操作，开销较大，为了降低数据搬迁的开销，DuckDB 采用了一种称为 <code>Two-Part Aggregate Hash Table</code> 的结构，如下：</p><img src=/images/database/two_part_hashtable.png alt=image-20230610102431044 style=zoom:50%><p><code>Hash Table</code> 分成两部分，真实的分组数据放在右边部分，称为 <code>payload blocks</code>；左边部分存储每个分组数据的位置信息（包含 Block 和块内偏移）。扩容时，只需要读取右边的分组数据，<code>rehash</code> 定位到新桶，然后修改对应桶的位置信息指向对应的分组数据。如下所示：</p><img src=/images/database/resize_two_part_hashtable.png alt=image-20230610103359695 style=zoom:50%><p>将所有的分组数据都做一遍 <code>rehash</code> 也是一个较大的开销，特别是对于字符串类型的数据来说，这个开销更明显。怎么解决这个问题呢？一个自然的想法就是用空间换时间，将 <code>hash</code> 值也存起来，那么下一次用的时候直接读取即可。DuckDB 就是这样做的，如下所示：</p><img src=/images/database/add_hash_payload.png alt=image-20230610104349627 style=zoom:50%><p><code>Two-Part Aggregate Hash Table</code> 有没有什么明显的问题呢？进一步分析下，在线性探测的过程中，首先在左边部分获取到对应桶的地址信息，然后再去右边的 <code>payload block</code> 中读取数据。很明显，同一个 <code>payload block</code> 时内存连续的，如果在线性探测的过程中顺序读取的分组数据在同一个 <code>payload block</code> 中，大概率能够命中 CPU Cache。</p><p>但是，左边 <code>Hash Table</code> 中的地址是无序的，也就意味着在顺序 SCAN <code>Hash Table</code> 时读取的 <code>payload block</code> 是随机的。问题的解决办法是，在左边的 <code>Hash Table</code> 中也带上分组数据的原始 <code>hash</code> 值，如下：</p><img src=/images/database/add_hash_pointarray.png alt=image-20230610111006351 style=zoom:50%><p>在线性探测时，首先对比当前分组的 <code>hash</code> 值和 <code>Hash Table</code> 中的 <code>hash</code> 值，如果相等，再通过地址找到对应的分组数据并和当前分组数据做比较。如果 <code>hash</code> 值不等，那么便可直接跳过当前桶，继续往下探测，从而减少了随机访问次数。</p><h2 id=parallel-aggregation>Parallel Aggregation</h2><p>通过上面的设计，现在已经得到了一个高效的 <code>Hash Table</code> 。由于 <code>Hash Table</code> 不支持并发读写，不能充分发挥现代 CPU 并行处理能力。DuckDB 参考论文
<a href=https://15721.courses.cs.cmu.edu/spring2016/papers/p743-leis.pdf title="Leis et al." rel="noopener external nofollow noreferrer" target=_blank class=exturl>Leis et al.
<i class="fa fa-external-link-alt"></i></a> 将原始表数据切分成多个 morsel，然后由多个线程独立处理其对应的 morsel 构建 <code>local hash table</code>，这一步可以达到并发。</p><p>如果两个分组的 <code>hash</code> 值不同，那么这两个分组值肯定不同。根据这一点，我们可以用分组的 <code>hash</code> 值将各个 <code>Hash Table</code> 切分成多个分区，相同 <code>hash</code> 值的数据分到相同的分区，如下：</p><img src=/images/database/partion_hashtable.png alt=image-20230610120313857 style=zoom:50%><p>然后每个线程负责 reduce 对应的分区数据，生成新的 <code>Hash Table</code> 。由于最终合并出来的多个 <code>Hash Table</code> 间的分组值各不相同，因此将各自的输出结果简单整合起来就是最终的分组结果。</p><p>这个并行处理的方式下面这篇文章的思路类似，详细可以看这篇文章：</p><h2 id=experiment>Experiment</h2><p>DuckDB 通过下面三组数据分别对比了不同分析引擎的分组时延，如下：</p><img src=/images/database/group_exp1.png alt=image-20230610121525116 style=zoom:50%>
<img src=/images/database/group_exp2.png alt=image-20230610121558331 style=zoom:50%>
<img src=/images/database/group_exp3.png alt=image-20230610121619524 style=zoom:50%><p>总的来看，DuckDB 在三种场景下，性能都远超其他引擎，看起来优化效果确实很牛。</p><h2 id=conclusion>Conclusion</h2><p><code>Hash Table</code> 在数据分析中应用十分广泛，对 <code>Hash Table</code> 的设计和优化做到极致是非常有必要的。DuckDB 作为一款性能出众的 OLAP 数据库，在这方面做了很多的工作，有机会拜读相关源码再继续补充分析。</p><h2 id=reference>Reference</h2><ul><li><a href=https://duckdb.org/2022/03/07/aggregate-hashtable.html title=https://duckdb.org/2022/03/07/aggregate-hashtable.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://duckdb.org/2022/03/07/aggregate-hashtable.html
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://15721.courses.cs.cmu.edu/spring2016/papers/p743-leis.pdf title=https://15721.courses.cs.cmu.edu/spring2016/papers/p743-leis.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://15721.courses.cs.cmu.edu/spring2016/papers/p743-leis.pdf
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/duckdb>duckdb</a>
<a href=/tags/olap>olap</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong>
DuckDB：高性能并行分组聚合</li><li class=post-copyright-author><strong>Written By:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/ title=DuckDB：高性能并行分组聚合>/post/2023-06-10-parallel-grouped-aggregation-in-duckdb/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"></div><div class="post-nav-prev post-nav-item"><a href=/post/2023-05-28-numbericdocvalues-layout/ rel=prev title="lucene DocValues之NumericDocValues">lucene DocValues之NumericDocValues
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"debuger6/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.95d37ca8344f2f635c0f13f77cc75191efb6cdf99093ed73203a86e05f995fbb.js defer></script></body></html>