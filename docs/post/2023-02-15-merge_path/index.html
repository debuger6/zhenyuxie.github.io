<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读"><meta itemprop=description content="Simple is the best."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="mergesort,database"><meta property="og:type" content="article"><meta property="og:title" content="Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/2023-02-15-merge_path/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="2023-02-15 22:00:00 +0800 CST"><meta property="article:modified_time" content="2023-02-15 22:00:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"2023-02-15-merge_path","permalink":"/post/2023-02-15-merge_path/","title":"Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读 - debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>9</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#介绍>介绍</a></li><li><a href=#merge-path>Merge Path</a></li><li><a href=#并行合并和排序>并行合并和排序</a></li><li><a href=#测试>测试</a></li><li><a href=#小结>小结</a></li><li><a href=#reference>Reference</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>9</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/zhenyuxie title="Github → https://github.com/zhenyuxie" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=22597></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=50></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-02-15T22:00:00+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/zhenyuxie rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/2023-02-15-merge_path/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读"><meta itemprop=description content="在看DuckDB技术博客时，了解到这篇论文。文章提出的算法非常实用，在工程实践中应用效果也很好。本文主要对论文核心部分进行解读，并会根据自己"></span><header class=post-header><h1 class=post-title itemprop="name headline">Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:2023-02-15 22:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-02-15 22:00:00 +0800 CST">2023-02-15</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93 itemprop=url rel=index><span itemprop=name>数据库</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>2538</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>6min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/2023-02-15-merge_path/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/post/2023-02-15-merge_path/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>在看DuckDB技术博客时，了解到这篇论文。文章提出的算法非常实用，在工程实践中应用效果也很好。本文主要对论文核心部分进行解读，并会根据自己的理解加以叙述，若有不当之处，欢迎纠正。</p></blockquote><h3 id=介绍>介绍</h3><p>在工程实践中，合并两个有序数组是非常常见的操作。最直观的实现方式就是采用一次归并排序，直接将两个有序数组合并生成一个新的有序数组。这种方式简单直观，也最容易实现，在数据集比较小的时候，性能特别好，时延几乎不计。但是在数据集较大的情况下，对于数据库这种对时延较为苛刻的系统来说，时延则不得不成为一个关注点。</p><p>在现代CPU多核架构下，可以充分利用CPU并行计算能力，采用多线程并行合并可以成倍提升性能，降低时延。</p><p>给一个长度为 $n$ 的乱序数组，将其排序，考虑merge-sort算法，需要 $\log_2n$ 轮排序，第一轮排序需要将 $n/2$ 个 $pairs$ 比较排序，第二轮需要将 $n/4$ 个 $pairs$ 排序，最后一轮将 $2$ 个 $pairs$ 排序生成单独的排序数组。</p><p>考虑使用并行merge-sort算法，使用 $p$ 核计算机，假设 $n&#187;p$，在前面的轮次，每个核可以负责一批 $pairs$ 的排序工作，越往后需要排序的 $pairs$ 更少，那么并不是每个核都能分得 $pairs$，不能充分发挥并行化计算能力。为了有效地发挥并行计算能力，需要对有序数组的合并也并行化，这样每个核在任何时候都能参与计算。</p><p>论文认为一个高效的并行合并算法必须具备如下特征：</p><ul><li>所有核拥有相同的工作量（负载均衡）</li><li>尽可能少的核间通信</li><li>最小化额外工作（为了并行化所做的额外工作）</li><li>高效内存访问（高缓存命中率和最小的缓存一致性开销）</li></ul><p>一种简单的方法是将两个有序数组按照核数平均切割成多个子数组，然后每个核分配一对长度相同的子数组，各个核排序生成一个有序数组，再将所有有序数组串联起来便得到最终的排序数组。如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>arr1 = [1,3,5,7,9,11,13,15,17]   split to --&gt; [1,3,5]        [7,9,11]        [13,15,17]
</span></span><span style=display:flex><span>arr2 = [2,4,6,8,10,12,14,16,18]  split to --&gt; [2,4,6]        [8,10,12]       [14,16,18]
</span></span><span style=display:flex><span>                                            core0|          core1|           core2|
</span></span><span style=display:flex><span>                                           [1,2,3,4,5,6,  7,8,9,10,11,12,  13,14,15,16,17,18]
</span></span></code></pre></div><p>如上，假设有3核，两个数组都等分成3个子数组，然后每个核合并一对子数组，最终得到一个合并完成的有序数组。一切看起来都没有问题。但是假设两个数组如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>arr1 = [20,21,22,23,24,25,26,27,28]  split to --&gt; [20,21,22]          [23,24,25]        [26,27,28]
</span></span><span style=display:flex><span>arr2 = [10,11,12,13,14,15,16,17,18]  split to --&gt; [10,11,12]          [13,14,15]        [16,17,18]
</span></span><span style=display:flex><span>                                                  core0|              core1|            core2|
</span></span><span style=display:flex><span>                                              [10,11,12,20,21,22,  13,14,15,23,24,25  16,17,18,26,27,28]
</span></span></code></pre></div><p>很不幸，上面的排序结果不对，因此，正确的数组划分成为了关键点。</p><p>论文提出了一种用于并行随机存取机 (Parallel Random Access Machines, PRAM) 的并行合并算法，即允许并发（并行）访问内存的共享内存架构。论文的算法具备负载均衡、无锁、高效内存访问的特点，仅需少量额外工作。为了实现高效的并行算法，论文提出了一种叫做 Merge Path 的方法，这也是论文的核心，下文将详细分析 Merge Path 的原理。</p><h3 id=merge-path>Merge Path</h3><p>假设两个有序数组 $A$ 和 $B$，长度分别为 $|A|$ 和 $|B|$， $A$ 和 $B$ 构成矩阵 $M$，如下图所示：</p><img src=/images/database/merge-path-1.png alt=image-20230211205857408 style=zoom:50%><blockquote><p>声明：本文所有图片都来源于原论文。</p></blockquote><p>我们来看下 Merge path 是如何构造的。要合并两个有序数组，我们从起点(1, 1)开始，比较 $A[1]$ 和 $B[1]$，如果 $A[1]>B[1]$，将位置往右移动，否则往下移动，重复上述步骤直到走到右下方终点。最终得到一条路径（图中黄色路径），这条路径就称为 Merge Path。</p><p>通过构造 Merge Path 可以得出下面几个结论：</p><p><strong>引理1</strong>：从头到尾遍历 Merge Path 的过程中，向右则选取 $|B|$ 中未使用的最小值，向下则选取 $|A|$ 中未使用的最小值，最终得到的结果即为合并后的有序数组。</p><p><strong>引理2</strong>：合并路径上，任何<strong>连续片段</strong>都由 $A$ 的连续元素序列和 $B$ 的连续元素序列组成。</p><p><strong>引理3</strong>：合并路径的<strong>非重叠</strong>片段由不相交的元素集组成，反之亦然。</p><p><strong>引理4</strong>：对于合并路径上两个<strong>不相交</strong>的片段，后面片段的元素集肯定大于或等于前面片段的元素集。</p><p><strong>定理5</strong>：考虑一组子数组对（来源于$A$ 和 $B$），这些子数组对包含了所有元素，它们一旦排序便形成了合并路径的连续片段。可以断言，这些子数组对可以并行合并，合并后的结果拼接在一起便形成了最终的有序数组。</p><p><strong>推论6</strong>：将合并路径划分为任何个<strong>不重叠</strong>的片段，这些片段对应的子数组对都可以独立合并，合并后的结果按片段顺序串联形成一个合并路径上有序数组。</p><p><strong>推论7</strong>：将合并路径<strong>平均划分</strong>为相同大小的片段，并行地合并片段对应的数组对，可以在多个处理器间达到<strong>负载均衡</strong>的效果。</p><h3 id=并行合并和排序>并行合并和排序</h3><p>有了上面的结论，我们来看下如何实现高效的并行合并算法。根据推论6和7，可以知道，需要将合并路径按照cpu核数平均划分，得到大小均匀的片段，然后并行地合并这些片段对应的数组对即可。要均匀地划分合并路径，其实就是要找到这些划分点，因此，算法的核心就是找这些划分点。算法核心思想如下：</p><ul><li>根据核数计算出每个线程处理的数据量</li><li>对于每个线程，计算其所处理的起点偏移</li><li>对于每个线程，根据起点偏移计算其在合并路径上对应的坐标点$(x, y)$</li><li>对于每个线程，根据自身的起点坐标点和终点坐标点(下一个线程的起点)合并数组对</li><li>对于每个线程，将合并的结果写入最终数组对应的下标即可（根据前面的引理可知不同线程片段对应的元素集不会重复，因此这里不会出现内存并发安全问题）</li></ul><p>通过上面的算法便能找到所有划分点，如下图：</p><img src=/images/database/merge-path-2.png alt=image-20230211230438935 style=zoom:50%><p>划分点将合并路径平均分割，然后由每个线程独立地合并排序每个片段对应的数组对，得到最终的合并数组。论文提供了算法的实现代码，见
<a href=https://github.com/ogreen/MergePathOMP title=github地址 rel="noopener external nofollow noreferrer" target=_blank class=exturl>github地址
<i class="fa fa-external-link-alt"></i>
</a>。笔者测了下，有点小bug（在某些情况下可能会coredump，笔者用Golang重新实现了算法，见
<a href=https://github.com/zhenyuxie/MergePath title=github地址 rel="noopener external nofollow noreferrer" target=_blank class=exturl>github地址
<i class="fa fa-external-link-alt"></i>
</a>）。</p><h3 id=测试>测试</h3><p>测试环境：MacBook Air M1 芯片，逻辑核数 8</p><p>测试数据量：$A$ 和 $B$ 的size均为1亿，合并成2亿的数组</p><p>直接用论文提供的代码测试，测试结果如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>$ make test100m
</span></span><span style=display:flex><span>./a.out -A <span style=color:#ae81ff>100000000</span> -B <span style=color:#ae81ff>100000000</span> -t <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>OpenMP MergePath Implementation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Merging: A<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> B<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> to C<span style=color:#f92672>[</span>200000000<span style=color:#f92672>]</span> using <span style=color:#ae81ff>2</span> threads
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serial merge 0.745051
</span></span><span style=display:flex><span>Total OpenMP MergePath 0.379064
</span></span><span style=display:flex><span>Speedup over serial merge 1.965501
</span></span><span style=display:flex><span>MERGE SUCCESSFUL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total Time 0.437201
</span></span><span style=display:flex><span>./a.out -A <span style=color:#ae81ff>100000000</span> -B <span style=color:#ae81ff>100000000</span> -t <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>OpenMP MergePath Implementation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Merging: A<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> B<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> to C<span style=color:#f92672>[</span>200000000<span style=color:#f92672>]</span> using <span style=color:#ae81ff>4</span> threads
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serial merge 0.745274
</span></span><span style=display:flex><span>Total OpenMP MergePath 0.195741
</span></span><span style=display:flex><span>Speedup over serial merge 3.807443
</span></span><span style=display:flex><span>MERGE SUCCESSFUL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total Time 0.231412
</span></span><span style=display:flex><span>./a.out -A <span style=color:#ae81ff>100000000</span> -B <span style=color:#ae81ff>100000000</span> -t <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>OpenMP MergePath Implementation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Merging: A<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> B<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> to C<span style=color:#f92672>[</span>200000000<span style=color:#f92672>]</span> using <span style=color:#ae81ff>8</span> threads
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serial merge 0.750698
</span></span><span style=display:flex><span>Total OpenMP MergePath 0.132132
</span></span><span style=display:flex><span>Speedup over serial merge 5.681429
</span></span><span style=display:flex><span>MERGE SUCCESSFUL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total Time 0.160297
</span></span><span style=display:flex><span>./a.out -A <span style=color:#ae81ff>100000000</span> -B <span style=color:#ae81ff>100000000</span> -t <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>OpenMP MergePath Implementation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Merging: A<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> B<span style=color:#f92672>[</span>100000000<span style=color:#f92672>]</span> to C<span style=color:#f92672>[</span>200000000<span style=color:#f92672>]</span> using <span style=color:#ae81ff>16</span> threads
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serial merge 0.750842
</span></span><span style=display:flex><span>Total OpenMP MergePath 0.126917
</span></span><span style=display:flex><span>Speedup over serial merge 5.916009
</span></span><span style=display:flex><span>MERGE SUCCESSFUL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Total Time 0.164079
</span></span></code></pre></div><p>线程数从2到16递增，线程数越多，并发数越大，MergePath 算法也就越快。当然线程数并不是越多越好，最佳线程数和CPU配置有关系。从上面的结果可以看出，当线程数为16时，并行Merge比普通Merge快了将近6倍，说明并行Merge的实践表现效果非常优秀。</p><h3 id=小结>小结</h3><p>本文主要解读了论文核心部分，还有些遗留内容并未解读，如果想了解更详细内容，可以直接看原论文。同时，笔者用Golang实现了论文中的算法（更加易懂），源码已上传github，感兴趣的同学可以阅读参考。</p><h3 id=reference>Reference</h3><ul><li><a href=https://arxiv.org/pdf/1406.2628.pdf title=https://arxiv.org/pdf/1406.2628.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://arxiv.org/pdf/1406.2628.pdf
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://github.com/ogreen/MergePathOMP title=https://github.com/ogreen/MergePathOMP rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/ogreen/MergePathOMP
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/mergesort>mergesort</a>
<a href=/tags/database>database</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong>
Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读</li><li class=post-copyright-author><strong>Post Author:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/post/2023-02-15-merge_path/ title="Merge Path - A Visually Intuitive Approach to Parallel Merging 论文解读">/post/2023-02-15-merge_path/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"></div><div class="post-nav-prev post-nav-item"><a href=/2022/12/13/lucene-dmw/ rel=prev title="lucene 编码技术 - DirectMonotonicWriter">lucene 编码技术 - DirectMonotonicWriter
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"zhenyuxie/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>