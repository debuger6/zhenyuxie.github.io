<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="lucene DocValues之SortedDocValues"><meta itemprop=description content="Simple is the best."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="DocValues,lucene"><meta property="og:type" content="article"><meta property="og:title" content="lucene DocValues之SortedDocValues"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/2023-09-05-sorteddocvalues-layout/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="2023-09-05 23:00:00 +0000 UTC"><meta property="article:modified_time" content="2023-09-05 23:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"2023-09-05-sorteddocvalues-layout","permalink":"/post/2023-09-05-sorteddocvalues-layout/","title":"lucene DocValues之SortedDocValues","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>lucene DocValues之SortedDocValues - debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>18</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#整体思路>整体思路</a></li><li><a href=#内存结构>内存结构</a></li><li><a href=#文件结构>文件结构</a><ul><li><a href=#dvd>dvd</a><ul><li><a href=#fielddocvaluesdata>FieldDocValuesData</a></li><li><a href=#termsdictdata>TermsDictData</a></li><li><a href=#termsindexdata>TermsIndexData</a></li></ul></li><li><a href=#dvm>dvm</a><ul><li><a href=#termsdictmeta>TermsDictMeta</a></li><li><a href=#termindexmeta>TermIndexMeta</a></li></ul></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>18</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>19</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=50640></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=112></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-09-05T23:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/debuger6 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/2023-09-05-sorteddocvalues-layout/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="lucene DocValues之SortedDocValues"><meta itemprop=description content="整体思路 为了方便理解 SortedDocValues 的存储原理，本节将通过一个简单的例子来讲解并构造一种简易的存储结构，意在理清 SortedDocValues 的设计思路。 SortedDocValues 要存的是 docIDs 及其对应的 fie"></span><header class=post-header><h1 class=post-title itemprop="name headline">lucene DocValues之SortedDocValues</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:2023-09-05 23:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-09-05 23:00:00 +0000 UTC">2023-09-05</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/lucene itemprop=url rel=index><span itemprop=name>lucene</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>3838</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>8min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/2023-09-05-sorteddocvalues-layout/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/post/2023-09-05-sorteddocvalues-layout/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=整体思路>整体思路</h2><p>为了方便理解 SortedDocValues 的存储原理，本节将通过一个简单的例子来讲解并构造一种简易的存储结构，意在理清 SortedDocValues 的设计思路。</p><p>SortedDocValues 要存的是 docIDs 及其对应的 fieldValues，fieldValue 的类型为字节数组。举个例子，假如有如下文档：</p><table><thead><tr><th style=text-align:center>doc</th><th style=text-align:center>sdv_field</th><th style=text-align:center>other_field</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>Luce</td><td style=text-align:center>Based on luceneIn action</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>Lucene</td><td style=text-align:center></td></tr><tr><td style=text-align:center>2</td><td style=text-align:center></td><td style=text-align:center>Just</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>Lu</td><td style=text-align:center>Go</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>Lucene</td><td style=text-align:center>Search engine</td></tr></tbody></table><p>以 sdv_field 为例，如果在内存里面表示 doc 和对应的 fieldValue，最直观想到的是使用 HashMap 来存储。那么内存里面的数据为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>HashMap: <span style=color:#f92672>{&lt;</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> Luce<span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> Lucene<span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> Lu<span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>4</span><span style=color:#f92672>,</span> Lucene<span style=color:#f92672>&gt;}</span> <span style=color:#75715e>// key 为 docID，value 为 term
</span></span></span></code></pre></div><p>磁盘上的数据为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>docIDs:  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>terms:   Luce Lucene Lu Lucene
</span></span><span style=display:flex><span>offsets: <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>12</span> <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>bitmap:  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0001</span> <span style=color:#ae81ff>1011</span>
</span></span></code></pre></div><p>上述存储方式有什么缺陷？</p><ul><li>缺陷1：有 terms 重复存储，假如有大量重复的 terms，那么会导致存储（内存及磁盘）空间严重浪费</li><li>缺陷2：terms 没有规律，按写入顺序存储，压缩效果不好</li></ul><p>好了，解决缺陷1的方式很容易想到，通常的做法就是使用字典编码，fieldValues 存储相应的编号即可；解决问题2的方式可以先将 terms 排序，然后前缀编码后再整体压缩。这样一来，在内存中的结构为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>HashMap:  <span style=color:#f92672>{&lt;</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>4</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>3</span><span style=color:#f92672>&gt;}</span> <span style=color:#75715e>// key 为 DocID，value 为 termID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>idToTerm: <span style=color:#f92672>{&lt;</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> Luce<span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> Lucene<span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> Lu<span style=color:#f92672>&gt;}</span> <span style=color:#75715e>// key 为 termID，值为 term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>ordMap: <span style=color:#f92672>{&lt;</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>&gt;,</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>3</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>&gt;}</span> <span style=color:#75715e>// key 为 termID, 值为 ord
</span></span></span></code></pre></div><p>磁盘上的数据为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>docIDs:   <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>ords:     <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>termDict: Lu Luce Lucene <span style=color:#75715e>// 排序存储为了更好的编码效率，编码后应该是 Lu ce cene，这里为了方便理解，还是展示原始值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>offsets:  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>6</span> <span style=color:#ae81ff>12</span>
</span></span></code></pre></div><p>这里主要关注磁盘结构，假如要查找 doc 4 对应的 term：</p><ol><li>首先在 docIDs 中查找 doc 4 是否存在，如果不存在则直接返回空，当然这里存在，找到其在序列中的偏移为 3</li><li>在 ords 相同的偏移处取出 ord 2</li><li>在 offsets 位置 2 和 3 处取出 offset 6 和 12</li><li>从 termDict 位置 6 开始取到 12，得到 term 为 Lucene</li></ol><p>通过上述例子，可以形象地理解 termID 和 ord 的概念和作用。termID 是 term 的插入顺序编号，在内存中凡是使用 term 的地方都可以使用 termID 替代，从而节约内存。ord 是 term 排序后的编号，代表了 term 的字典序，在磁盘上 ord 就是 term 在 termDict 中的相对位置，从而可以更快地定位查找数据。</p><p>另外还有个作用是，由于 termID 和 ord 都是递增生成的。因此内存中可以使用数组替换 HashMap，不仅节约内存，而且效率更高。</p><h2 id=内存结构>内存结构</h2><p>上面介绍了 termID 和 ord 的作用及构造了一种内存结构和磁盘结构，其实这就是 lucene 的实现思路，只是在实现上，lucene 做得更精细。下面来看看 SortedDocValues 在 lucene 中是如何实现的。</p><p>来看下 SortedDocValues 的内存结构：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SortedDocValuesWriter</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>final</span> BytesRefHash hash<span style=color:#f92672>;</span> <span style=color:#75715e>// 哈希表，存 termID -&gt; term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> PackedLongValues<span style=color:#f92672>.</span><span style=color:#a6e22e>Builder</span> pending<span style=color:#f92672>;</span> <span style=color:#75715e>// 临时使用，存所有 termIDs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> DocsWithFieldSet docsWithField<span style=color:#f92672>;</span> <span style=color:#75715e>// 存包含当前 field 的所有 docIDs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> PackedLongValues finalOrds<span style=color:#f92672>;</span> <span style=color:#75715e>// 存所有 termIDs，由 pending 压缩编码转变而来。这个变量名取得不严谨，有点迷惑人。docsWithField 和 finalOrds 结合起来可以看做 docIDTOTermsID map
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> finalSortedValues<span style=color:#f92672>;</span> <span style=color:#75715e>// 按 term 排序后的 termIDs. 下标是 ord，值为 termID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[]</span> finalOrdMap<span style=color:#f92672>;</span> <span style=color:#75715e>// 存 termID-&gt;ord 的映射关系，下标是 termID，值为 ord
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addValue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> docID<span style=color:#f92672>,</span> BytesRef value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 省略一些不重要的代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  addOneValue<span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  docsWithField<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>docID<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  lastDocID <span style=color:#f92672>=</span> docID<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addOneValue</span><span style=color:#f92672>(</span>BytesRef value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// value 即 term
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> termID <span style=color:#f92672>=</span> hash<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>termID <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span> <span style=color:#75715e>// value 已经存在
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    termID <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>termID <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    iwBytesUsed<span style=color:#f92672>.</span><span style=color:#a6e22e>addAndGet</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>BYTES</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pending<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>termID<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  updateBytesUsed<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>数据写进来时，先存放在前面 3 个变量中，各变量的作用见注释。flush 时，会调用 SortedDocValuesWriter.finish 方法，生成后面 3 个变量，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>finish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>finalSortedValues <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> valueCount <span style=color:#f92672>=</span> hash<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    updateBytesUsed<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> finalOrdMap <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> finalOrds <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    finalSortedValues <span style=color:#f92672>=</span> hash<span style=color:#f92672>.</span><span style=color:#a6e22e>sort</span><span style=color:#f92672>();</span> <span style=color:#75715e>// 返回排序后的 terms 对应的 termIDs. 下标是 ord，值为 termID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    finalOrds <span style=color:#f92672>=</span> pending<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    finalOrdMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>[</span>valueCount<span style=color:#f92672>];</span> <span style=color:#75715e>// 下标是 termID, 值是 ord
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> ord <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span> ord <span style=color:#f92672>&lt;</span> valueCount<span style=color:#f92672>;</span> ord<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      finalOrdMap<span style=color:#f92672>[</span>finalSortedValues<span style=color:#f92672>[</span>ord<span style=color:#f92672>]]</span> <span style=color:#f92672>=</span> ord<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>注意看 finalSortedValues 是 hash.sort 的结果，返回的值是按 terms 排序后的 termIDs 这个 int 数组，数组的下标就是 ord。因此 ord 其实代表按字典序排序后的 term 的大小序，这和我们上节介绍的概念吻合。</p><p>数据最终会 flush 到磁盘，那么在 flush 到磁盘前，内存中的结构如何呢。如下：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/lucene/SortedDocValues_flush.png alt=image-20230829230217487></p><p>在 flush 时，内存中的数据包含上图 5 个变量。</p><p>为了更形象地理解几个变量的含义，举个例子。如下表，有 5 行数据，每行包含字段 sdv_field、other_field。</p><table><thead><tr><th style=text-align:center>doc</th><th style=text-align:center>sdv_field</th><th style=text-align:center>other_field</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:center>Lucene</td><td style=text-align:center>In action</td></tr><tr><td style=text-align:center>1</td><td style=text-align:center>Elasticsearch</td><td style=text-align:center>Based on lucene</td></tr><tr><td style=text-align:center>2</td><td style=text-align:center></td><td style=text-align:center>Just</td></tr><tr><td style=text-align:center>3</td><td style=text-align:center>Action</td><td style=text-align:center>Go</td></tr><tr><td style=text-align:center>4</td><td style=text-align:center>Elasticsearch</td><td style=text-align:center>Search engine</td></tr></tbody></table><p>以 sdv_field 为例，内存数据变化如下：</p><ol><li><p>插入 doc 0</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    
</span></span><span style=display:flex><span>termID    0
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0]
</span></span></code></pre></div><p>pending</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0]
</span></span></code></pre></div></li><li><p>插入 doc 1</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    Elasticsearch
</span></span><span style=display:flex><span>termID    0             1
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1]
</span></span></code></pre></div><p>pending</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1]
</span></span></code></pre></div></li><li><p>插入 doc 2</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    Elasticsearch
</span></span><span style=display:flex><span>termID    0             1
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1]
</span></span></code></pre></div><p>pending</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1]
</span></span></code></pre></div></li><li><p>插入 doc 3</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    Elasticsearch   Action
</span></span><span style=display:flex><span>termID    0             1            2
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 3]
</span></span></code></pre></div><p>pending</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 2]
</span></span></code></pre></div></li><li><p>插入 doc 4</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    Elasticsearch   Action
</span></span><span style=display:flex><span>termID    0             1            2
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 3, 4]
</span></span></code></pre></div><p>pending</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 2, 1]
</span></span></code></pre></div></li><li><p>flush</p><p>hash</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>term:   Lucene    Elasticsearch   Action
</span></span><span style=display:flex><span>termID    0             1            2
</span></span></code></pre></div><p>docsWithField</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 3, 4]
</span></span></code></pre></div><p>finalOrds</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>[0, 1, 2, 1]
</span></span></code></pre></div><p>finalSortedValues</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>]</span> <span style=color:#75715e>// 按 term 排序后的 termID，相当于 ord-&gt; termID 的映射，下标是 ord，值是 termID
</span></span></span></code></pre></div><p>finalOrdMap</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#ae81ff>2</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>]</span> <span style=color:#75715e>// termID-&gt;ord 映射，下标是 termID，值是 ord
</span></span></span></code></pre></div></li></ol><p>前 5 步是数据在 flush 前的内存存储形式，第 6 步是 flush 时 finish 后的内存存储。以上便是 SortedDocValues 的内存结构，下面会详细介绍 SortedDocValues 在文件中的组织结构。</p><h2 id=文件结构>文件结构</h2><p>文件 Layout 总览如下图：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/lucene/SortedDocValues_Layout.png alt=image-20230905222955049></p><h3 id=dvd>dvd</h3><p>先介绍数据文件 dvd，所有类型的 DocValues 都一样，dvd 由三大部分组成：Header、FieldDocValuesData、Footer。本节着重介绍 FieldDocValuesData 部分，Header、Footer 忽略。</p><h4 id=fielddocvaluesdata>FieldDocValuesData</h4><p>Field 对应的 docValues 数据，包含四部分：docsWithField、FieldValues、TermsDictData、TermsIndexData。</p><p>docsWithField 和 FieldValues 的存储方式和 NumericDocValues 一模一样。只不过，这里 FieldValues 存的是 ords。真实的 term 值存在 TermsDictData 中的，下面会详细介绍。</p><h4 id=termsdictdata>TermsDictData</h4><p>TermsDictData 指的是字典数据，实际上存的是排序后的 terms。 数据按 Block 划分存储，64 个 terms 为一个 Block。Block 前缀编码后通过 LZ4 压缩。下面介绍下 Block 中存的内容。</p><h5 id=firsttermlength>firstTermLength</h5><blockquote><p>Block 中第一个 term 的长度。</p></blockquote><h5 id=firsttermvalue>firstTermValue</h5><blockquote><p>Block 中第一个 term 的值。</p></blockquote><h5 id=othertermsinfo>otherTermsInfo</h5><blockquote><p>表示除第一个 term 以外的其他 term 的信息。假如 Block（例如最后一个 Block） 中只有第一个 term，那么这块内容是不存在。来看下这块包含的内容有哪些。</p></blockquote><p><strong>prefixLength | suffixLength-1</strong></p><p>prefixLength 表示<strong>当前 term 和前一个 term 的共同前缀长度</strong>，suffixLength 为后缀长度，即当前 term 的长度减去 prefixLength 。将 prefixLength 和 suffixLength 编码在一起，共用 1 个 byte，从而节省空间。那么这里为什么是 suffixLength-1 呢？</p><p>这里引用下源码，方便解释。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>bufferedOutput<span style=color:#f92672>.</span><span style=color:#a6e22e>writeByte</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>prefixLength<span style=color:#f92672>,</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>)</span> <span style=color:#f92672>|</span> <span style=color:#f92672>(</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span><span style=color:#ae81ff>15</span><span style=color:#f92672>,</span> suffixLength <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>)</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span><span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>prefixLength <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  bufferedOutput<span style=color:#f92672>.</span><span style=color:#a6e22e>writeVInt</span><span style=color:#f92672>(</span>prefixLength <span style=color:#f92672>-</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>suffixLength <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>16</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  bufferedOutput<span style=color:#f92672>.</span><span style=color:#a6e22e>writeVInt</span><span style=color:#f92672>(</span>suffixLength <span style=color:#f92672>-</span> <span style=color:#ae81ff>16</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>bufferedOutput<span style=color:#f92672>.</span><span style=color:#a6e22e>writeBytes</span><span style=color:#f92672>(</span>term<span style=color:#f92672>.</span><span style=color:#a6e22e>bytes</span><span style=color:#f92672>,</span> term<span style=color:#f92672>.</span><span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> prefixLength<span style=color:#f92672>,</span> suffixLength<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>把一个 byte 分成低 4 位和高 4 位，prefixLength 存低 4 位，suffixLength 存高 4 位。</p><p>注意，低 4 位为 15（二进制：1111）时，此时该值并不表示 prefixLength，而表示 prefixLength >= 15。其实比较好理解，因为 4 位最大表示 15，因此，[0, 14] 区间的值可以正常表示；大于等于 15 时，用标识 15 表示；由于 15 已经用作标识，所以不能表示 prefixLength。</p><p>同理，高 4 位为 15 时，也是用作标识，并不表示 suffixLength。但高 4 位存的是 suffixLength - 1 的值，因为必满足 suffixLength > 0 （dict 存的是 term 的唯一值），因此，suffixLength 为区间 [1, 15] 时，可以正常表示。</p><p><strong>prefixLength-15</strong></p><blockquote><p>共同前缀长度减去 15 后的值，很明显减 15 是为了节省空间。</p></blockquote><p><strong>suffixLength-16</strong></p><blockquote><p>同上。</p></blockquote><p><strong>suffixValue</strong></p><blockquote><p>除去前缀后余下的后缀值。</p></blockquote><h5 id=blockadress>BlockAdress</h5><blockquote><p>Block 在文件中的偏移地址，是一个递增的数组，通过 DirectMonotonicWriter 编码存储。</p></blockquote><p>DirectMonotonicWriter 介绍见
<a href=https://debuger.tech/2022/12/13/lucene-dmw/ title=链接 rel="noopener external nofollow noreferrer" target=_blank class=exturl>链接
<i class="fa fa-external-link-alt"></i>
</a>。</p><h4 id=termsindexdata>TermsIndexData</h4><p>好了，根据 docID 可以找到对应的 ord，进而找到 term。那么反过来，要根据 term 查找其对应的 ord 该怎么办呢？当然可以将 TermsDictData 的每个 Block 解压出来，然后二分遍历查找。假如要查找的 term 比较靠后，那么将要解压+二分查找很多 Block，开销非常大。</p><p>更好的方式是什么呢，那就是对 terms 建立索引。lucene 的做法是，每 1024 个 terms 为一组，取出前一组的最后一个 term 和当前组的第一个 term，然后计算前缀值并加上当前 term 的后缀值的第一个 byte 建立稀疏索引。这么说有点抽象，举个例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>第一组：{&#34;abc&#34;, &#34;abcd&#34;, ... , &#34;bird&#34;}
</span></span><span style=display:flex><span>第二组：{&#34;birger&#34;, &#34;birguz&#34;, ... , &#34;chooce&#34;}
</span></span><span style=display:flex><span>第三组：{&#34;chorm&#34;, &#34;chorg&#34;, ... , &#34;debug&#34;}
</span></span><span style=display:flex><span>第四组：{&#34;dog&#34;, &#34;down&#34;, ... , &#34;lucene&#34;}
</span></span></code></pre></div><ol><li><p>取第一组最后一个 term 值 “bird”，第二组第一个值 “birger”，计算前缀为 “bir”，再加上后缀第一个 byte 结果为 “birg”</p></li><li><p>取第二组最后一个 term 值 “chooce”，第三组第一个值 “chorm”，计算前缀为 “cho”，再加上后缀第一个 byte 结果为 “chor”</p></li><li><p>取第三组最后一个 term 值 “debug”，第四组第一个值 “dog”，计算前缀为 “d”，再加上后缀第一个 byte 结果为 “do”</p></li><li><p>得到最终的索引数据为 [“birg”, “chor”, “do”]</p></li></ol><p>假如查询 term 值为 “boss”，由于 “boss” 介于 “birg” 和 “chor” 之间，所以应该在第 1024 和 第 2048 区间查找 term，即第 16 到 32 个 Block 间查找。通过索引，可以极大缩小查找范围，提高查找效率。</p><h5 id=prefixvalue>prefixValue</h5><blockquote><p>即上面说的相邻两组间后一组第一个 term 和前一组最后一个 term 的共同前缀值加后缀第一个字符。</p></blockquote><h5 id=offset>offset</h5><blockquote><p>每个 prefixValue 对应的偏移，prefixValuesOffsets 通过 DirectMonotonicWriter 编码存储。</p></blockquote><h3 id=dvm>dvm</h3><p>dvm 是 dvd 的元数据，由三部分构成：Header、FieldMeta、Footer。本节着重介绍 FieldMeta 部分，Header、Footer 忽略。</p><p>FieldMeta 第一部分数据和 NumericDocValues 的元数据一致，这里不过多介绍，主要介绍 TermsDictMeta 和 TermsIndexMeta。</p><h4 id=termsdictmeta>TermsDictMeta</h4><p>TermsDictData 的元数据，下面详细介绍。</p><h5 id=size>size</h5><blockquote><p>ords 的个数，和 docIDs 的个数相同。</p></blockquote><h5 id=direct_monotonic_block_shift>DIRECT_MONOTONIC_BLOCK_SHIFT</h5><blockquote><p>创建 DirectMonotonicWriter 所需，决定了 DirectMonotonicWriter 内部 buffer 大小。</p></blockquote><h5 id=directmonotonicwritermeta>DirectMonotonicWriterMeta</h5><p>DirectMonotonicWriter 编解码 TermsBlockAddress 所需元数据（注意，这里可能会有多个，上图只画了一个），来看看具体包含哪些值。</p><p><strong>min</strong></p><blockquote><p>待编码数组中的最小值。</p></blockquote><p><strong>avgInc</strong></p><blockquote><p>数组的平均增长值。</p></blockquote><p><strong>offset</strong></p><blockquote><p>DirectMonotonicWriter 当前 block 的偏移相对起始位置的偏移 （DirectMonotonicWriter 内部可能会触发多次 flush，因此可能产生多个 block）。</p></blockquote><p><strong>bitsRequired</strong></p><blockquote><p>每个值所占 bits 数。</p></blockquote><h5 id=maxlength>maxLength</h5><blockquote><p>最大 term 长度。</p></blockquote><h5 id=termsblockmeta>TermsBlockMeta</h5><p><strong>maxBlockLength</strong></p><blockquote><p>最大 Block 长度。</p></blockquote><p><strong>offset</strong></p><blockquote><p>TermsDictData 在 dvd 中的偏移。</p></blockquote><p><strong>length</strong></p><blockquote><p>TermsDictData 的长度。</p></blockquote><h5 id=termsblockaddressmeta>TermsBlockAddressMeta</h5><p><strong>offset</strong></p><blockquote><p>TermsBlockAddress 在 dvd 中的偏移。</p></blockquote><p><strong>length</strong></p><blockquote><p>TermsBlockAddress 的长度。</p></blockquote><h4 id=termindexmeta>TermIndexMeta</h4><h5 id=terms_dict_reverse_index_shift>TERMS_DICT_REVERSE_INDEX_SHIFT</h5><blockquote><p>移位数 10，代表一个 block 有 1024 个 terms。</p></blockquote><h5 id=directmonotonicwritermeta-1>DirectMonotonicWriterMeta</h5><blockquote><p>DirectMonotonicWriter 编解码 prefixValuesOffsets 所需元数据，详细参数前面已介绍过。</p></blockquote><h5 id=prefixvaluesmeta>prefixValuesMeta</h5><p><strong>offset</strong></p><blockquote><p>prefixValues 在 dvd 中的偏移。</p></blockquote><p><strong>length</strong></p><blockquote><p>prefixValues 的长度。</p></blockquote><h5 id=prefixvaluesoffsetsmeta>prefixValuesOffsetsMeta</h5><p><strong>offset</strong></p><blockquote><p>prefixValuesOffsets 在 dvd 中的偏移。</p></blockquote><p><strong>length</strong></p><blockquote><p>prefixValuesOffsets 的长度。</p></blockquote><h2 id=总结>总结</h2><p>本文介绍了 SortedDocValues 的内存结构和磁盘结构，并通过例子构建了一种简易的存储结构，帮助理解 SortedDocValues 的设计原理。可以看到 SortedDocValues 和 NumericDocValues 大部分地方是相似的，只是多了 TermsDict 和 TermsIndex 两部分，大家可以结合前面 NumericDocValues 的文章一起看，更易理解。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/docvalues>DocValues</a>
<a href=/tags/lucene>lucene</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong>
lucene DocValues之SortedDocValues</li><li class=post-copyright-author><strong>Written By:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/post/2023-09-05-sorteddocvalues-layout/ title="lucene DocValues之SortedDocValues">/post/2023-09-05-sorteddocvalues-layout/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"></div><div class="post-nav-prev post-nav-item"><a href=/post/2023-08-30-idea-debuger-tostring/ rel=prev title="问题记录 - 谁偷走了我的内存">问题记录 - 谁偷走了我的内存
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"debuger6/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.95d37ca8344f2f635c0f13f77cc75191efb6cdf99093ed73203a86e05f995fbb.js defer></script></body></html>