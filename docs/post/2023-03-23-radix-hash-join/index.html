<!doctype html><html lang=zh-cn data-theme=light><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.109.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读"><meta itemprop=description content="Simple is the best."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="hash join,database"><meta property="og:type" content="article"><meta property="og:title" content="Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读"><meta property="og:description" content="Simple is the best."><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/2023-03-23-radix-hash-join/"><meta property="og:site_name" content="debuger"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="debuger"><meta property="article:published_time" content="2023-03-23 23:00:00 +0800 CST"><meta property="article:modified_time" content="2023-03-23 23:00:00 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.42b65f4b5d8fdb26467483a54df0d4f1570d2f58db628dde5a9075d4ba6c423c.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"2023-03-23-radix-hash-join","permalink":"/post/2023-03-23-radix-hash-join/","title":"Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读 - debuger</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label="Toggle navigation bar" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>debuger</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>大道至简</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>技术博客
<span class=badge>14</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=Searching... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#介绍>介绍</a></li><li><a href=#background-in-memory-hash-joins>BACKGROUND: IN-MEMORY HASH JOINS</a><ul><li><a href=#canonical-hash-join-algorithm>Canonical Hash Join Algorithm</a></li><li><a href=#no-partitioning-join>No Partitioning Join</a></li><li><a href=#radix-join>Radix Join</a></li><li><a href=#parallel-radix-join>Parallel Radix Join</a></li></ul></li><li><a href=#小结>小结</a></li><li><a href=#reference>Reference</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=debuger src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>debuger</p><div class=site-description itemprop=description>Simple is the best.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>8</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/debuger6 title="Github → https://github.com/debuger6" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/xzy-51-38 title="知乎 → https://www.zhihu.com/people/xzy-51-38" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title="Creative Commons"><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt="Creative Commons"></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>Web Status</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>Running:</div><div class=item-count id=runTimes data-publishdate=2022-01-20T22:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>Visitors:</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>Views:</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>Words:</div><div class=item-count id=wordsCount data-count=39959></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>ReadTime:</div><div class=item-count id=readTimes data-times=88></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>Last Update:</div><div class=item-count id=last-push-date data-lastpushdate=2023-06-09T23:30:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title="Go to Comment"><i class="fas fa-comments"></i></div><div id=goto-gtranslate class=button title="Multilingual translation"><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/debuger6 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/2023-03-23-radix-hash-join/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="debuger"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="debuger"><meta itemprop=description content="Simple is the best."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读"><meta itemprop=description content="这篇论文介绍了如何在多核 CPU 上结合底层硬件参数（能力）调优 Main-Memory Hash Joins 算法。 介绍 hash join 是一种常见的数据库操作，用于将两个表中的行通过一个共同的 join 键连接"></span><header class=post-header><h1 class=post-title itemprop="name headline">Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>Publish on:</span>
<time title="Publish on:2023-03-23 23:00:00 +0800 CST" itemprop="dateCreated datePublished" datetime="2023-03-23 23:00:00 +0800 CST">2023-03-23</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93 itemprop=url rel=index><span itemprop=name>数据库</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span><span>3094</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>7min</span></span>
<span class=post-meta-item title=Views><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>Views:</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/2023-03-23-radix-hash-join/><i class="fa fa-sync fa-spin"></i></span></span>
<span class=post-meta-item title=Comments><span class=post-meta-item-icon><i class="far fa-comments"></i></span>
<span class=post-meta-item-text>Comments:</span>
<span class=waline-comment-count data-path=/post/2023-03-23-radix-hash-join/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><blockquote><p>这篇论文介绍了如何在多核 CPU 上结合底层硬件参数（能力）调优 Main-Memory Hash Joins 算法。</p></blockquote><h3 id=介绍>介绍</h3><p><code>hash join</code> 是一种常见的数据库操作，用于将两个表中的行通过一个共同的 join 键连接起来。<code>hash join</code> 通常可以分为基于磁盘和基于内存两种方式。在基于磁盘的 <code>hash join</code> 中，数据需要从磁盘读入内存，这样可能会导致高延迟和低效率。相比之下，基于内存的 <code>hash join</code> 通常比较快速和高效。</p><p>然而，随着多核 CPU 的出现，基于内存的 <code>hash join</code> 也面临着一些新的挑战。在多核 CPU 上，数据的并发读写可能会导致缓存争用和内存带宽瓶颈等问题，从而影响 <code>hash join</code> 的性能。因此，需要对基于内存的 <code>hash join</code> 算法进行优化，以充分利用多核 CPU 的计算能力和内存带宽。该论文旨在提出一种针对多核 CPU 的主存 <code>hash join</code> 方法，并优化该方法以适应底层硬件的特性。</p><h3 id=background-in-memory-hash-joins>BACKGROUND: IN-MEMORY HASH JOINS</h3><p>现有的算法可分为两大阵营，一种是 *Hardware-oblivious（硬件无感）*的 <code>hash join</code>，即算法不考虑硬件相关的参数，相反，他们从现代硬件的特征考虑，认为可以在任何技术相似的硬件上取得良好的性能，代表有 <em>no partitioning join</em>。</p><p>另一种是 *Hardware-conscious（硬件有感）*的实现，这种方法旨在通过调整算法参数（如 hash table 大小等）来最大化利用硬件特性，代表有 <em>radix join</em>。</p><h4 id=canonical-hash-join-algorithm>Canonical Hash Join Algorithm</h4><p><img src=/imgs/img-lazy-loading.gif data-src=/images/database/hash-join-no-partition.png alt=image-20230320234439659></p><p>任何现代 <code>hash join</code> 实现的基础都是 <code>canonical hash join</code>，<code>canonical Hash Join</code> 算法的主要思想是将两个表的连接操作转化为一个哈希表的建立和查找操作。主要分为两个阶段：<em>build phase</em> 和 <em>probe phase</em>。算法如上图 Fig. 1 所示，步骤如下：</p><ol><li><strong>Scan</strong> 较小表 \(R\)，并对其中的 join 列建立哈希表，哈希表的键为 join 列的值，哈希表的值为连接列所在行的指针或行的副本</li><li><strong>Scan</strong> 较大表 \(S\)，对于每一行，使用哈希函数计算连接列的哈希值，查找哈希表中对应的条目，并与当前行进行匹配</li><li>如果匹配成功，则将两个表的对应行合并，并输出到结果集中</li><li>如果没有匹配，则继续处理下一行</li><li>处理完所有行之后，输出结果集</li></ol><p>两个表都需要 scan 一次，假设 hash 表的访问是常数时间开销，那么 <em>canonical hash join</em> 算法的时间复杂度为 \(O(|R|+|S|)\)。</p><h4 id=no-partitioning-join>No Partitioning Join</h4><p>为了利用现在并行硬件的优势，业界提出了一种 <em>canonical hash join</em> 算法的变体 <em>no partitioning join</em>。该算法中的 no partitioning 指的是不对哈希表分区，但是会对数据表分区。这种算法不依赖硬件的任何特定参数，该算法如上图 Fig. 2 所示。</p><p>两张表都会被均分成多个部分（<em>portions</em>），这些 <em>portions</em> 会分配给多个线程并行处理。在 <em>build phase</em>，所有线程都会 scan 自己负责的 <em>portions</em> 生成一个全局的哈希表。由于哈希表是所有线程共享的，也就意味着向哈希表插入数据需要 <em>synchronized</em>，线程在向哈希表中的 bucket 插入数据时，需要先上锁，上锁成功后才能插入数据。论文指出这里潜在的锁竞争会比较少，因为哈希 bucket 的个数往往比较多，<u>由于锁是 bucket 粒度的，所以锁冲突的概率比较低</u>。</p><p><em>probe phase</em> 访问哈希表是只读模式，因此在该阶段不用加锁，并行访问的效率会很高。假设系统有 \(p\) 个核，那么该算法在理想情况下（<em>build phase</em> 锁冲突概率极低）的时间复杂度为 \(O(1/p(|R|+|S|))\)。</p><h4 id=radix-join>Radix Join</h4><p>哈希表可以通过 key 的哈希值直接访问，效率很高，但是随机访问内存也会带来 <code>cache misses</code> 问题。论文中引用了其他论文说明了 cache misses 会影响查询性能。业界也证明了当哈希表的大小大于了 cache 大小，几乎每次哈希表的访问都会导致 cache miss。因此，将哈希表划分成 cache 大小的块可以减少 cache misses，从而提高性能。同时，论文还提到在分区阶段，需要考虑 TLB misses 的问题，这样便引出了 <em>radix join</em> 算法。</p><h5 id=partitioned-hash-join>Partitioned Hash Join</h5><p><img src=/imgs/img-lazy-loading.gif data-src=/images/database/paritioned-hash-join.png alt=image-20230321223511075></p><p>如上图 Fig. 3. 第一阶段，关系表 \(R\) 和 \(S\) 经过哈希函数 \(h1\) 哈希分区为 \(ri\) 和 \(sj\)；在 <em>build phase</em>，针对每个分区 \(ri\) 通过哈希函数 \(h2\) 构建单独的哈希表，由于每个分区对应一个哈希表，这样哈希表的大小便能适配 CPU cache；在 <em>probe phase</em>，scan \(sj\) 并在对应的哈希表中查找匹配的 tuples 做 join。</p><p>由于在 <em>partitioning phase</em>，\(R\) 和 \(S\) 使用相同的哈希函数 \(h1\) 做哈希分区，因此可以得出以下结论：
$$
ri \Join sj = \emptyset (i\neq j)
$$
通过哈希分区构建哈希表的方式，解决了哈希表过大导致 cache misses 的问题，但同时又引来了新的问题。由于 \(h1\) 的散出可能很大，哈希分区会产生特别多的 partitions，这些 partitions 往往分布在不同的内存页里。我们知道，操作系统里面内存管理的方式是将内存划分为页来管理，进程通过虚拟地址来访问内存时，需要访问页表找到对应的物理页进而找到对应的物理地址，从而实现地址转换。</p><p>地址转换的开销是比较大的，操作系统需要通过 TLB 这一高速缓存来缓存经常被用到的页表项，从而提升地址转换的速度。由于 partitions 可能会比较多，从而会占用很多内存页，进而导致内存页数远远超过 TLB 所能缓存的页表项，那么在访问 partitions 时大概率会导致 TLB misses，造成性能问题。</p><h5 id=radix--partitioning>Radix Partitioning</h5><p><img src=/imgs/img-lazy-loading.gif data-src=/images/database/radix-join.png alt=image-20230322225729922></p><p>通过简单的哈希分区，会导致 TLB misses 问题，为了解决这一问题，引出了一种新的分区方法 <em>radix partitioning</em>，如上图 Fig. 4. <em>radix partitioning</em> 会分成多轮（pass），每一轮选取 join 键的不同 bits 来哈希分区，下一轮的输出作为下一轮的输入，通过多轮的方式保证最终的散出不超过 TLB 最大缓存页表项数。由于每一轮都是选取的不同位（a different set of bits），类似基数排序每轮选取不同位排序，因此这种分区算法叫做 <em>radix partitioning</em>。</p><p>介绍完 <em>radix partitioning</em>，再来讲 <em>radix join</em> 就比较好理解了，步骤和上述类似：</p><ol><li>通过 <em>radix partioning</em>，将 \(R\) 和 \(S\) 划分为数量可控的 \(ri\) 和 \(sj\)</li><li>对每个 \(ri\) 构建单独的哈希表</li><li>scan \(sj\) 在对应的哈希表中查找匹配的 tuples 做 join</li></ol><p>在 <em>radix partitioning</em> 的多轮分区中，每轮最大散出时根据硬件参数来固定设置的，那么 paritioning 的轮数为 \(log|R|\)，因此 <em>radix join</em> 的时间复杂度为 \(O((|R|+|S|)log|R|)\)。</p><p><em>radix join</em> 需根据硬件调整的参数如下：</p><ol><li>每轮 <em>radix partitioning</em> 的最大散出需要根据硬件支持的 TLB 数来限制</li><li>生成的分区大小需要大致（不能大于）和 CPU cache 保持一致</li></ol><h4 id=parallel-radix-join>Parallel Radix Join</h4><p><em>radix join</em> 能够并行化处理，需要将关系表切分成多个子表，将这些子表分配给多个线程，每个线程将自己负责的子表哈希到相应的 partitions，根据上一节讲的，需要考虑硬件参数来限制数量，因此 partitions 的数量不会太多。由于多个线程都会往 partitions 写数据，因此这里存在潜在的竞争问题，由于 partitions 的数量有限，这里竞争的概率就比较大（对比 <em>no partitioning join</em> 低概率竞争）。</p><p>为了避免线程竞争问题，这里有个比较有意思的做法是，每个 partiton 预先为每个线程保留相应大小区间范围，然后每个线程计算写入 partiton 的位置，将对应的数据写入相应位置即可。这里由于每个线程写入的位置一定不同，所以可以不用加锁同步。论文其实没有详细讲并行 partitioning 的具体方法，为了便于理解，下面引用 CMU Andy Pavlo 教授的课件来讲解下并行 <em>radix partitioning</em> 的步骤。</p><p>第一步，每个线程 scan 子表，然后统计 <em>radix hash</em> 后各个 partiton 的 histogram（其实就是每个 partition 的 tuple 个数），如下图：</p><img src=/images/database/radix-patition-step1.png alt=image-20230323231418607 style=zoom:70%><p>第二步，计算每个线程输出的偏移位置，第一步完了后，其实可以得到一个序列如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-text data-lang=text><span style=display:flex><span>2 1 2 3 // 分别表示 thread-0 在 partition-0, thread-1 在 partiton-0, thread-0 在 partiton-1，thread-1在 partition-1 中的数量
</span></span></code></pre></div><p>然后根据上述序列可以生成一个序列，叫做 <em>prefixSum</em> 如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>0 0+2 0+2+1 0+2+1+2 =&gt; 0 2 3 5 // 每个值代表上述序列每个元素位置的前缀和
</span></span></code></pre></div><p>计算出的 <em>prefixSum</em> 序列就是各线程在 partitons 中的偏移位置，如下：</p><img src=/images/database/radix-partition-step2.png alt=image-20230323233052998 style=zoom:70%><p>第三步，每个线程再一次 scan 子表，将数据写入 partitions 相应位置，如下：</p><img src=/images/database/radix-partition-step3-1.png alt=image-20230323233226996 style=zoom:70%>
<img src=/images/database/radix-partition-step3-2.png alt=image-20230323233437201 style=zoom:70%><p>最后，选取其他 bit，递归上述的 <em>parallel radix partitioning</em> 步骤，直到得到目标个数的 partitions：</p><img src=/images/database/radix-partition-step4.png alt=image-20230323233706205 style=zoom:70%><p>通过上面的讲解，并行 <em>radix partitioning</em> 的实现原理应该比较清晰了。partitioning 完毕后，后面的 <em>build</em> 和 <em>probe</em> 不存在线程竞争，可以抽象成 task，交给线程池并行处理。到此，整篇论文的原理讲解完毕。</p><h3 id=小结>小结</h3><p>本文主要解读了论文的核心原理，论文实验数据部分没有贴上来，大家感兴趣可以查看原始论文。本文整体讲解脉络和论文保持一致，有些地方是笔者根据自己的理解来叙述讲解的，如果不当之处，欢迎指正！</p><h3 id=reference>Reference</h3><ul><li><a href=https://15721.courses.cs.cmu.edu/spring2016/papers/balkesen-icde2013.pdf title=https://15721.courses.cs.cmu.edu/spring2016/papers/balkesen-icde2013.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://15721.courses.cs.cmu.edu/spring2016/papers/balkesen-icde2013.pdf
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://15721.courses.cs.cmu.edu/spring2023/slides/11-hashjoins.pdf title=https://15721.courses.cs.cmu.edu/spring2023/slides/11-hashjoins.pdf rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://15721.courses.cs.cmu.edu/spring2023/slides/11-hashjoins.pdf
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/hash-join>hash join</a>
<a href=/tags/database>database</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>Post Title:</strong>
Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读</li><li class=post-copyright-author><strong>Post Author:</strong>
debuger</li><li class=post-copyright-link><strong>Post Link:</strong>
<a id=post-cr-link href=/post/2023-03-23-radix-hash-join/ title="Main-Memory Hash Joins on Multi-Core CPUs/ Tuning to the Underlying Hardware 论文解读">/post/2023-03-23-radix-hash-join/</a></li><li class=post-copyright-license><strong>Copyright Notice:</strong>
All articles in this blog are licensed under <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> unless stating additionally.</li></ul></div><div class=followme><span>Welcome to my other publishing channels</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/2023-04-16-fastest-table-sort/ rel=next title="Fastest table sort in the West - Redesigning DuckDB’s sort"><i class="fa fa-chevron-left"></i> Fastest table sort in the West - Redesigning DuckDB’s sort</a></div><div class="post-nav-prev post-nav-item"><a href=/post/2023-02-19-es-paginate/ rel=prev title="深入理解 Elasticsearch 分页技术">深入理解 Elasticsearch 分页技术
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>Comments</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=giscus-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>debuger</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.109.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Announcements","categoryid":"DIC_kwDOIqmyr84CTQGv","emit":false,"inputposition":"top","mapping":"title","reactions":true,"repo":"debuger6/zhenyuxie.github.io","repoid":"R_kgDOIqmyrw","theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":230},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","得意"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script>
<script type=text/javascript src=/js/math.min.95d37ca8344f2f635c0f13f77cc75191efb6cdf99093ed73203a86e05f995fbb.js defer></script></body></html>